#!/usr/bin/env python3
"""Generate nvchecker.toml from PKGBUILDs and schema.jsonc.

Tracks:
- Direct dependencies (PKGBUILD depends)
- Optional dependencies (PKGBUILD optdepends)
- All installable packages (schema.jsonc)

Usage:
    ./NVGEN > nvchecker.toml

Then install and run nvchecker:
    pacman -S nvchecker
    nvchecker -c nvchecker.toml        # First run creates new_ver.json
    nvcmp -c nvchecker.toml            # Compare and show updated packages
    nvtake -c nvchecker.toml PKG...    # Mark packages as seen/processed
"""

import re
import sys
from pathlib import Path


def log(msg: str) -> None:
	"""Print progress to stderr."""
	print(msg, file=sys.stderr)


ROOT = Path(__file__).parent.parent  # nvchecker/ -> repo root
SCHEMA_PATH = ROOT / 'archinstoo' / 'archinstoo' / 'schema.jsonc'
PKGBUILD_DEV = ROOT / 'PKGBUILD'
PKGBUILD_REL = ROOT / 'archinstoo' / 'PKGBUILD'


def load_schema() -> dict:
	"""Load schema.jsonc, stripping // comments."""
	import json
	text = SCHEMA_PATH.read_text()
	text = re.sub(r'(?m)^\s*//.*$|(?<=,)\s*//.*$', '', text)
	return json.loads(text)


def parse_pkgbuild_array(path: Path, name: str) -> list[str]:
	"""Extract bash array from PKGBUILD (depends, optdepends, etc)."""
	text = path.read_text()
	pattern = rf"{name}=\(\s*([\s\S]*?)\)"
	match = re.search(pattern, text)
	if not match:
		return []

	content = match.group(1)
	# Extract quoted strings, strip comments and version info
	items = re.findall(r"['\"]([^'\"]+)['\"]", content)
	# Clean: 'systemd: description' -> 'systemd', strip versions
	cleaned = []
	for item in items:
		pkg = item.split(':')[0].split('>=')[0].split('<=')[0].split('=')[0].strip()
		if pkg:
			cleaned.append(pkg)
	return cleaned


def expand_group(name: str) -> list[str]:
	"""Expand a package group to its members using pacman."""
	import subprocess
	log(f'  expanding group: {name}')
	try:
		result = subprocess.run(
			['pacman', '-Sqg', name],
			capture_output=True, text=True, check=True
		)
		pkgs = result.stdout.strip().split('\n') if result.stdout.strip() else []
		log(f'    -> {len(pkgs)} packages')
		return pkgs
	except subprocess.CalledProcessError:
		log(f'    -> failed')
		return []


def extract_schema_packages(schema: dict) -> set[str]:
	"""Recursively extract all package names from schema.

	Only extracts strings from lists (actual package names).
	Dict keys are profile/category names, not packages.
	Expands package groups to their members.
	"""
	pkgs: set[str] = set()

	# Package groups to expand
	groups = {
		'gnome', 'xfce4', 'xfce4-goodies', 'mate', 'mate-extra',
		'lxqt', 'deepin', 'budgie', 'cosmic', 'cutefish',
	}
	expanded: set[str] = set()

	def walk(obj):
		if isinstance(obj, list):
			for item in obj:
				if isinstance(item, str):
					name = item.lower()
					if name in groups:
						if name not in expanded:
							expanded.add(name)
							pkgs.update(expand_group(name))
					else:
						pkgs.add(name)
				else:
					walk(item)
		elif isinstance(obj, dict):
			for v in obj.values():
				walk(v)

	walk(schema)
	return pkgs


def detect_source(pkg: str) -> str:
	return 'pacman'

def generate_toml() -> str:
	log('Loading schema...')
	schema = load_schema()

	log('Parsing PKGBUILDs...')
	depends = set(parse_pkgbuild_array(PKGBUILD_DEV, 'depends'))
	depends.update(parse_pkgbuild_array(PKGBUILD_REL, 'depends'))

	optdepends = set(parse_pkgbuild_array(PKGBUILD_DEV, 'optdepends'))
	optdepends.update(parse_pkgbuild_array(PKGBUILD_REL, 'optdepends'))

	log('Extracting packages from schema...')
	schema_pkgs = extract_schema_packages(schema)

	# Build output
	lines = [
		'# nvchecker.toml - Auto-generated by NVGEN',
		'# Tracks all packages used by archinstoo',
		'#',
		'# Regenerate: ./NVGEN > nvchecker.toml',
		'#',
		'# Usage:',
		'#   pacman -Sy                    # Sync db first (pacman source uses local db)',
		'#   nvchecker -c nvchecker.toml   # Check versions (creates/updates new_ver.json)',
		'#   nvcmp -c nvchecker.toml       # Compare old vs new versions',
		'#   nvtake -c nvchecker.toml PKG  # Mark package as seen (or --all)',
		'',
		'[__config__]',
		'oldver = "old_ver.json"',
		'newver = "new_ver.json"',
		'',
		'# ============================================================',
		'# ARCHINSTOO',
		'# ============================================================',
		'[archinstoo]',
		'source = "git"',
		'git = "https://github.com/h8d13/archinstoo"',
		'branch = "master"',
		'use_commit = true',
		'',
	]

	def add_section(title: str, pkgs: set[str]):
		if not pkgs:
			return
		lines.append(f'# ============================================================')
		lines.append(f'# {title}')
		lines.append(f'# ============================================================')
		for pkg in sorted(pkgs):
			lines.append(f'[{pkg}]')
			lines.append(f'source = "{detect_source(pkg)}"')
			lines.append('')

	add_section('DIRECT DEPENDENCIES', depends)
	add_section('OPTIONAL DEPENDENCIES', optdepends - depends)
	add_section('INSTALLABLE PACKAGES', schema_pkgs - depends - optdepends)

	total = len(depends) + len(optdepends - depends) + len(schema_pkgs - depends - optdepends) + 1  # +1 for archinstoo
	log(f'Done: {total} packages tracked')

	return '\n'.join(lines)


if __name__ == '__main__':
	print(generate_toml())
