#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PKG_GLOB="archinstoo-*.pkg.tar.zst"

go_to () {
	cd "$SCRIPT_DIR/archinstoo" || exit 1
}

pre_build () {
    rm -f ./*-any.pkg.tar.zst
}

clean () {
    rm -rf pkg src dist ./*.pkg.tar.zst.sig build ./*.egg-info ../*.egg-info ./*-git
} # make sure no old sigs

sign () {
    gpg --detach-sign "$PKG_GLOB"
}
verif() {
    gpg --verify "$PKG_GLOB".sig
}

for i in "$@"; do
	case $i in
        -t | --tree)
        shift
        go_to
        {
            echo '# Project Structure'
            echo '```'
            tree -I '*.po|*.pyc|*.mo|*.png|*.svg|locales|docs|__pycache__|__init__.py'
            echo '```'
        } > docs/readme.md
        exit 0
        ;;
        -c | --clean)
        shift
        go_to
        clean && pre_build
        exit 0
        ;;
        -b | --build)
        shift
        go_to
        pre_build
        makepkg -Cf
        clean
        exit 0
        ;;
        -s | --sign)
        shift
        go_to
        sign
        exit 0
        ;;
        -sv | --verify-sig)
        shift
        go_to
        verif
        exit 0
        ;;        
        -i|--install)
        shift
        go_to
        sudo pacman -U --overwrite '*' "$PKG_GLOB"
        exit 0
        ;;
        -v|venv)
        shift
        ./RUN
        exit 0
        ;;
        *)
        # Catch all with options also to local
        go_to
        python -B -m archinstall "$@"
        exit 0
        ;;
	esac
done

# No arguments - run local archinstall directly
go_to && python -B -m archinstall