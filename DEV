#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PKG_GLOB="archinstoo-*.pkg.tar.zst"

go_to () {
	cd "$SCRIPT_DIR/archinstoo" || exit 1
}

pre_build () {
    rm -f ./*-any.pkg.tar.zst
}

clean () {
    rm -rf pkg src dist ./*.pkg.tar.zst.sig build ./*.egg-info ../*.egg-info ./*-git
} # make sure no old sigs

sign () {
    # shellcheck disable=SC2086
    gpg --detach-sign $PKG_GLOB
}
verif() {
    # shellcheck disable=SC2086
    gpg --verify $PKG_GLOB.sig
}

case "$1" in
	-t | --tree)
	go_to
	{
		echo '# Project Structure'
		echo '```'
		tree -F -I '*.po|*.pyc|*.mo|*.png|*.svg|locales|docs|logs|__pycache__|__init__.py' | sed 's/\.py//g'
		echo '```'
	} > docs/readme.md
	;;
	-c | --clean)
	go_to
	clean && pre_build
	;;
	-b | --build)
	go_to
	pre_build
	makepkg -Cf
	clean
	;;
	-s | --sign)
	go_to
	sign
	;;
	-sv | --verify-sig)
	go_to
	verif
	;;
	-i|--install)
	go_to
	# shellcheck disable=SC2086
	sudo pacman -U --overwrite '*' $PKG_GLOB
	;;
    -tc | --test-config)
    ./RUN --config examples/config-sample.json
    ;;
	*)
	# Pass through to archinstall
	./RUN "$@"
	;;
esac
